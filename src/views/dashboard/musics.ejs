<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Dashboard | Music</title>
	<link rel="shortcut icon" href="/assets/icon/logo.ico" type="image/x-icon" />

	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css" />

	<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap"
		rel="stylesheet" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
		integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ=="
		crossorigin="anonymous" referrerpolicy="no-referrer" />

	<link rel="stylesheet" href="/css/upload.css" />
	<link rel="stylesheet" href="/css/dashboard.css" />
	<link rel="stylesheet" href="/css/loader-time.css" />
	<link rel="stylesheet" href="/css/loader-dancing.css" />

	<style>
		body {
			font-size: 0.875rem;
		}

		.sidebar {
			position: fixed;
			height: 100vh;
			background-color: #343a40;
			color: #fff;
			padding: 1rem;
		}

		.sidebar a {
			color: #fff;
			text-decoration: none;
		}

		.sidebar a:hover {
			text-decoration: none;
			background-color: #495057;
			border-radius: 0.25rem;
		}

		.content {
			padding: 2rem;
		}

		.navbar-dark .navbar-nav .nav-link {
			color: #fff;
		}

		.navbar-dark .navbar-nav .nav-link:hover {
			color: #ddd;
		}
	</style>

	<style>
		.delete-btn,
		.edit-btn {
			display: block;
			cursor: pointer;
			text-align: center;
			padding-left: 1em;
			padding-top: 0.9em;
		}

		.delete-btn:hover {
			color: #f11c;
		}

		.edit-btn:hover {
			color: #11fc;
		}

		.thumbnail-container {
			width: 100%;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		table .table-thumbnail {
			background-position: center;
			background-size: cover;
			background-repeat: no-repeat;
			display: block;
			height: 45px;
			width: 50px;
			border-radius: 5px;
		}

		#affirmModal .modal-content {
			position: absolute;
			left: 50%;
			top: 50%;
			transform: translate(-50%, 100%);
		}

		.favorite {
			text-align: center;
			color: #e75e86;
			font-size: 1rem;
		}

		.upload-modal .upload-container {
			background-color: #f7f7f7;
			position: fixed;
			left: 50%;
			top: 50%;
			transform: translate(-50%, -50%);

			width: 700px;
			display: flex;
			flex-direction: column !important;
			gap: 1em;
			justify-content: center;
			align-items: center;
			color: #1f2122 !important;
		}

		.upload-modal .upload-header {
			background-color: transparent;
			color: #1f2122;
			border-color: #5e8de720 !important;
			font-size: 1.5rem;
			font-weight: normal;
			width: 100%;
			text-align: left;
			padding-left: 1em;
		}

		.upload-container input,
		.upload-container input:focus {
			background-color: #f7f7f7;
			border-color: #f1f1f1;
			color: #1f2122;
		}

		.drag-drop {
			color: #575757;
		}

		.modal-header {
			display: flex;
			flex-direction: row;
			flex-wrap: nowrap;
			align-items: center;
		}

		.modal-header .modal-title {
			font-size: 1.5rem;
			/* font-weight: bold; */
		}

		.thumbnail-container {
			display: flex;
			flex-wrap: wrap;
		}

		.video-thumbnail,
		.lyrics-thumbnail {
			margin: 10px;
			cursor: pointer;
			/* width: 200px; */
			width: auto;
			height: 2rem;
			/* width: 5rem; */
			overflow: hidden;
			background-color: transparent;

			border-radius: 2px;
			/* border-radius: 23px; */
		}

		#videoModal .modal-dialog {
			max-width: 100% !important;
			width: 100%;
		}

		#videoModal .modal-content {
			width: 70vw;
			margin: auto;
			font-family: 'Poppins', sans-serif;
		}

		#videoModal .modal-body,
		#lyricsModal .modal-body {
			padding: 0 !important;
			width: 100% !important;
		}

		#videoModal .modal-footer,
		#lyricsModal .modal-footer {
			display: flex;
			align-items: center;
			justify-content: space-between !important;
			gap: 1em;
		}

		.has-search .form-control {
			padding-left: 2.375rem;
		}

		.has-search .form-control-feedback {
			position: absolute;
			z-index: 2;
			display: block;
			width: 2.375rem;
			height: 2.375rem;
			line-height: 2.375rem;
			text-align: center;
			pointer-events: none;
			color: #aaa;
		}

		.lyrics-container {
			padding: 1em;
			width: 100%;
			margin: 0;
			height: 50vh;
			border: none;
			resize: none;
		}

		.lyrics-container:focus {
			outline: none;
			border: 1px solid #57575757;
			border-left: none;
			border-right: none;
		}
	</style>
	<link rel="stylesheet" href="/css/toasts.css" />
</head>

<body>
	<div class="container-fluid">
		<div class="row">
			<!-- Sidebar -->
			<!-- Sidebar -->
			<!-- Sidebar -->
			<!-- Sidebar -->
			<!-- Sidebar -->
			<!-- Sidebar -->
			<nav class="col-md-2 d-none d-md-block sidebar">
				<div class="top-left text-center">
					<img onclick="location.href = '/'" style="cursor: pointer" src="/assets/images/logo.png" alt="logo"
						class="img-fluid rounded-circle" />
					<h5 class="mt-2">Dashboard | Musics</h5>
				</div>
				<hr />
				<form class="form-inline my-2 my-lg-0" style="display: none">
					<input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search" />
				</form>
				<ul class="nav flex-column">
					<li class="nav-item">
						<a class="nav-link active" href="/dashboard">Overview</a>
					</li>
					<!-- Accordion -->
					<li class="nav-item">
						<div id="accordion">
							<div class="card border-0">
								<div class="card-header border-0 p-0">
									<h5 class="mb-0">
										<button class="btn btn-link text-white" data-toggle="collapse" data-target="#collapseOne"
											aria-expanded="true" aria-controls="collapseOne">
											&nbsp;Dashboards <i class="fas fa-caret-down"></i>
										</button>
									</h5>
								</div>
								<div id="collapseOne" class="collapse dashboards" aria-labelledby="headingOne" data-parent="#accordion">
									<div class="card-body p-0">
										<ul class="nav flex-column">
											<li class="nav-item">
												<a class="nav-link" href="/dashboard/users"><i class="fas fa-users"></i> &nbsp; User
													Dashboard</a>
											</li>
											<li class="nav-item">
												<a class="nav-link" href="/dashboard/musics"><i class="fas fa-music"></i>&nbsp;&nbsp; Music
													Dashboard</a>
											</li>
										</ul>
									</div>
								</div>
							</div>
						</div>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#">Analytics</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#">Settings</a>
					</li>
				</ul>

				<hr />

				<h5 class="mt-4 quick-links">&nbsp;Quick Links</h5>
				<ul class="nav flex-column quick-links-container">
					<li class="nav-item">
						<a class="nav-link" href="/browse">Browse Musics</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="/practice">practice Typing</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="/practice">Piano Typing</a>
					</li>
				</ul>
			</nav>

			<!-- Main content -->
			<main role="main" class="col-md-10 ml-sm-auto px-4 content" style="padding: 0">
				<!-- Dashboard Navbar -->
				<div
					class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
					style="position: relative">
					<h1 class="h2">Dashboard Overview</h1>
					<div class="dropdown">
						<span class="profile-pic" data-toggle="dropdown" aria-expanded="false"></span>
						<div class="dropdown-menu" style="margin: auto; margin-right: 5rem">
							<a class="dropdown-item" href="/profile"><i class="fas fa-user-circle"></i> Profile</a>
							<a class="dropdown-item" href="#"><i class="fas fa-cog"></i> Settings</a>
							<a class="dropdown-item" href="/logout">Logout <i class="fas fa-sign-out-alt"></i></a>
						</div>
					</div>
				</div>

				<div style="
              width: 100%;
              padding: 1em 0;
              display: flex;
              justify-content: space-between;
              gap: 1em;
              align-items: center;
            ">
					<button style="margin-left: 1em" class="btn btn-primary" data-toggle="modal" data-target="#uploadModal">
						<i class="fas fa-cloud-upload-alt"></i> Upload
					</button>
					<div class="form-group has-search" style="margin: 0 !important">
						<span class="fa fa-search form-control-feedback"></span>
						<input type="text" class="form-control" placeholder="Search" />
					</div>
				</div>

				<div class="musics-table" style="width: 100%">
					<div class="col">
						<table class="table">
							<thead class="thead-dark">
								<tr>
									<th scope="col">#</th>
									<th scope="col">Music</th>
									<th scope="col">Artist</th>
									<th scope="col">Rating</th>
									<th scope="col">Views</th>
									<th scope="col">Created</th>
									<th scope="col">Video</th>
									<th scope="col">Lyrics</th>
									<th scope="col">Edit</th>
									<th scope="col">Delete</th>
								</tr>
							</thead>
							<tbody id="musicsTableBody">
								<% let ordinalNo=0; %>
									<% musics.forEach((music, index)=> { %>
										<% ordinalNo=index + 1; %>
											<tr id="<%= music._id %>">
												<th scope="row" class="ordinal">
													<%= index + 1 %>
												</th>
												<!-- <td class="thumbnail-container"><span style="background-image: url('<%= music.thumbnail %>');"
														class="table-thumbnail"></span></td> -->
												<td class="music-title">
													<%= music.title %>
												</td>
												<td class="music-artist">
													<%= music.artist %>
												</td>
												<td class="music-rating">
													<%= music.rating.toFixed(2) %>
												</td>
												<td class="music-views">
													<%= music.views %>
												</td>
												<td>
													<%= music.updatedAt %>
												</td>
												<td>
													<video class="video-thumbnail" data-id="<%= music._id %>"
														poster="https://res.cloudinary.com/dv5x2gpmz/image/upload/v1722103219/uploads/progress/sehmvzsercprkv74wpxp.png"
														preload="none" data-thumbnail="<%= music.thumbnail %>" data-video-url="<%= music.video %>"
														data-toggle="modal" data-target="#videoModal"></video>
												</td>
												<td>
													<img data-id="<%= music._id %>" class="lyrics-thumbnail"
														src="https://res.cloudinary.com/dv5x2gpmz/image/upload/v1722102753/uploads/progress/xibczkcluseoyguohpcv.png" />
												</td>
												<td class="delete-container">
													<i data-id="<%= music._id %>" class="fas fa-edit edit-btn"></i>
												</td>

												<td class="delete-container">
													<i data-id="<%= music._id %>" class="fas fa-trash-alt delete-btn"></i>
												</td>
											</tr>
											<% }); %>
							</tbody>
						</table>
					</div>
				</div>
			</main>
		</div>
	</div>

	<div class="modal fade upload-modal" tabindex="-1" id="uploadModal" aria-labelledby="uploadModalLabel"
		aria-hidden="true">
		<%- include('upload.ejs') %>
	</div>

	<div class="modal fade" id="videoModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" style="font-weight: bold" id="exampleModalLabel">
						Modal title
					</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<i class="fas fa-times"></i>
					</button>
				</div>
				<div class="modal-body">
					<video id="videoPlayer" width="100%" height="500px" controls></video>
				</div>
				<div class="modal-footer">
					<div class="column">
						<button type="button" class="btn rating" data-dismiss="modal">
							<span>4.8</span> <i class="fas fa-star-half-alt"></i>
						</button>
						<button type="button" class="btn views">
							<span>342</span> <i class="fas fa-users"></i>
						</button>
					</div>
					<div class="column">
						<!-- <button type="button" class="btn btn-secondary" data-dismiss="modal">342 <i class="fas fa-users"></i></button> -->
						<button type="button" class="btn btn-danger text-light play">
							<i class="fas fa-play-circle text-light"></i> &nbsp;Play
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="lyricsModal" tabindex="-1" aria-labelledby="lyricsModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" style="font-weight: bold" id="lyricsModalLabel">
						Modal title
					</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<i class="fas fa-times"></i>
					</button>
				</div>
				<div class="modal-body">
					<div class="loader-time"></div>
					<i class="fas fa-edit edit-lyrics" style="
                display: block;
                position: absolute;
                top: 1em;
                right: 1.75em;
                z-index: 100;
                cursor: pointer;
              "></i>
					<textarea name="lyrics-container" class="lyrics-container" readonly style="position: relative">
            </textarea>
				</div>
				<div class="modal-footer">
					<div class="column">
						<button type="button" class="btn rating" data-dismiss="modal">
							<span>4.8</span> <i class="fas fa-star-half-alt"></i>
						</button>
						<button type="button" class="btn views">
							<span>342</span> <i class="fas fa-users"></i>
						</button>
					</div>
					<div class="column">
						<!-- <button type="button" class="btn btn-secondary" data-dismiss="modal">342 <i class="fas fa-users"></i></button> -->
						<button type="button" class="btn btn-info text-light save">
							<i class="fas fa-save"></i> &nbsp;Save
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

	<script src="/js/toasts.js"></script>
	<script src="/js/affirm.js"></script>
	<!-- <script src="/js/upload.js" defer></script> -->
	<script src="/js/uploader.js" defer></script>
	<script src="/js/youtube.js" defer></script>

	<script>
		$(document).ready(function () {
			console.clear();
			// $('#uploadModal').modal('show');
			console.log('Hey there');
			toastSuccess('Musics loaded successfully!');

			// Preload high-quality image
			const img = document.getElementById('preload-img');
			img.src = '/assets/images/default_thumbnail.jpg';

			// Once high-quality image is loaded, set it as the background image
			img.onload = function () {
				$('.uploaded-thumbnail').css(
					'background-image',
					`url('/assets/images/default_thumbnail.jpg')`
				);
			};

			// Handle delete button click
			$(document).on('click', '.delete-btn', function () {
				let id = this.dataset.id.toString();

				affirm('Are you sure you want to delete this user?').then(
					(result) => {
						if (result) {
							console.log('Deleting user...');
							deleteUser(id);
						} else {
							console.log('Deletion cancelled!');
						}
					}
				);
			});

			function deleteUser(id) {
				fetch('/deleteMusic', {
					method: 'DELETE',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({ id }),
				})
					.then((response) => response.json())
					.then((res) => {
						toastSuccess(res.message);
						setTimeout(() => {
							location.reload();
						}, 2000);
					})
					.catch((err) => {
						toastDanger(err.message);
						console.error(err);
					});
			}
		});


		// Handle delete button click
		$(document).on('click', '.edit-btn', async function () {
			let id = this.dataset.id.toString();

			$('#upload-form').find('input[type="file').each((_, item) => {
				item.form.reset();
			});
			$('#upload-form').find('input[name="musicId"]').val(id);
			let res = await fetch(`/api/music/${id}`);
			let music = await res.json();
			$('#upload-form').find('.upload-title').text('Edit Music 🖊️');

			console.log('artist:', $('#upload-form').find('input[name="artist"]')[0]);
			$('#upload-form').find('.uploaded-thumbnail').attr('data-image-url', music.thumbnail);
			$('#upload-form').find('input[name="thumbnail"]').val(music.thumbnail);
			$('#upload-form').find('input[name="video"]').val(music.video);
			$('#upload-form').find('input[name="lyrics"]').val(music.lyrics);
			$('#upload-form').find('input[name="artist"]').val(music.artist);
			$('#upload-form').find('input[name="title"]').val(music.title);

			$('.uploaded-thumbnail').css('background-image', `url('${music.thumbnail}')`);
			function handleEdit(name, element) {
				const fileDetails = $(element).find('.file-details');
				const fileName = $(element).find('.file-name');
				const closeBtn = $(element).find('.cancel-upload');
				let icon = $(element).find('i');

				closeBtn.click(function (e) {
					e.preventDefault();
					$(icon[0]).show();
					fileDetails.hide();
					toastInfo('Upload removed');
					$(element).find('input[type="file')[0].form.reset();
					$(element).find('input[type="hidden').val('');
				});

				$(icon[0]).hide();
				fileDetails.show();
				fileName.html(`${name}`);
			}

			handleEdit(`${music.artist} - ${music.title}`, $('#upload-form').find('.video-drop')[0]);
			handleEdit(`${music.artist} - ${music.title}`, $('#upload-form').find('.lyrics-drop')[0]);
			console.log('showing modal');
			$('#uploadModal').modal('show');
		});
	</script>

	<script defer>
		$(document).ready(function () {
			$('#videoModal').on('hide.bs.modal', function (event) {
				console.log('closing music');
				var videoPlayer = document.getElementById('videoPlayer');
				videoPlayer.pause();
				videoPlayer.removeAttribute('src');
				videoPlayer.load();
			});

			// Add event listeners to thumbnails
			$('.video-thumbnail, .lyrics-thumbnail').each((_, thumbnail) => {
				$(thumbnail).on('click', async function (event) {
					$('#videoModal .modal-title').text('');
					$('#videoModal .music-rating').text('');
					$('#videoModal .music-views').text('');
					console.log('launching modal...');
					const musicId = $(thumbnail).data('id');
					let res = await fetch(`/api/music/${musicId}`);
					let music = await res.json();
					const thumbnailUrl = $(thumbnail).data('thumbnail');

					const musicContainer = $(`#${musicId}`);
					let title = $(musicContainer).find('.music-title').text();
					let views = $(musicContainer).find('.music-views').text();
					let artist = $(musicContainer).find('.music-artist').text();
					let rating = $(musicContainer).find('.music-rating').text();
					$('#videoModal .modal-title').text(`${artist} - ${title}`);
					$('#videoModal .rating').find('span').text(rating);
					$('#videoModal .views').find('span').text(views);
					$('#videoModal .play').on('click', function (event) {
						event.preventDefault();
						location.href = `/music/${musicId}`;
					});
					$('#videoModal #videoPlayer').text(views);

					var videoUrl = thumbnail.getAttribute('data-video-url');
					console.log('videoUrl:', videoUrl);
					var videoPlayer = document.getElementById('videoPlayer');
					videoPlayer.src = videoUrl;
					videoPlayer.poster = thumbnailUrl;
					$('#levelsModal').modal('show');
				});
			});

			$('#lyricsModal .edit-lyrics').on('click', function (event) {
				event.preventDefault();
				$(this).addClass('text-primary');
				$('#lyricsModal .lyrics-container').removeAttr('readonly');
			});

			$('#lyricsModal .lyrics-container').on('blur', function (event) {
				event.preventDefault();
				$(this).attr('readonly', true);
				$('#lyricsModal .edit-lyrics').removeClass('text-primary');
			});

			$('.lyrics-thumbnail').each((_, thumbnail) => {
				$(thumbnail).on('click', async function (event) {
					$('#lyricsModal .modal-title').text('');
					$('#lyricsModal .music-rating').text('');
					$('#lyricsModal .music-views').text('');
					$('#lyricsModal .lyrics-container').val('');
					$('#lyricsModal').modal('show');
					$('#lyricsModal .loader-time').show();
					const musicId = $(thumbnail).data('id');

					let res = await fetch(`/api/music/${musicId}`);
					let music = await res.json();
					$('#lyricsModal .modal-title').text(
						`${music.artist} - ${music.title}`
					);
					$('#lyricsModal .music-rating').text(music.rating);
					$('#lyricsModal .music-views').text(music.views);

					const lyricsUrl = music.lyrics;
					console.log('lyricsUrl:', lyricsUrl);
					res = await fetch(lyricsUrl);
					let lyrics = (await res.text()) || "Couldn't fetch the lyrics";

					$('#lyricsModal .loader-time').css('animation', 'none');
					$('#lyricsModal .loader-time').hide();
					$('#lyricsModal .lyrics-container').val(lyrics);
					$('#lyricsModal').find('button.save').on('click', function (event) {
						event.preventDefault();
						fetch('/music/lyrics', {
							method: 'PUT', 
							headers: { 'Content-Type': 'application/json' }, 
							body: JSON.stringify({ musicId, lyrics:  $('#lyricsModal .lyrics-container').val()}),
						});
						location.reload();
					});
				});
			});
		});
	</script>
</body>

</html>