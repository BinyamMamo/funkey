<!DOCTYPE html>
<html lang="en">

<head>

	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap"
		rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Rubik+Glitch+Pop&display=swap" rel="stylesheet">

	<!-- Bootstrap core CSS -->
	<!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous"> -->
	<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
		integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ=="
		crossorigin="anonymous" referrerpolicy="no-referrer" />

	<title>Funkey | Profile</title>


	<!-- Additional CSS Files -->
	<link rel="stylesheet" href="/css/funkey.css">
	<link rel="stylesheet" href="/css/homepage.css">
	<link rel="stylesheet" href="/css/levels.css">
	<link rel="stylesheet" href="/css/toasts.css">

	<link rel="shortcut icon" href="assets/icon/funkey.ico" type="image/x-icon">

	<style>
		.page-content {
			padding: 0 !important;
		}

		.header-area .main-nav {
			justify-content: space-between !important;
		}

		#affirmModal {
			color: #e1e1e1;
		}

		#affirmModal .modal-content {
			margin-top: 40%;
			background-color: #1f2122dd !important;
		}

		.login {
			padding: 0 !important;
			height: 1em !important;
			line-height: 1.2 !important;
			margin-top: 0.5em;
		}

		.btn:focus {
			outline: none;
			/* box-shadow: none; */
		}

		.logout-btn {
			background-color: transparent !important;
			color: #fff !important;
			text-decoration: none !important;
			/* border-color: #fff !important; */
			border-color: #0351a4aa !important;
			border-width: 2px;
			border-width: 2px !important;
			transition: border-width 0.5s ease;
		}

		.logout-btn:hover {
			font-weight: 700;
			border-width: 2px !important;
			border-color: #0351a4aa !important;
			background-color: transparent !important;
		}

		input#searchText {
			background-color: #1f2122dd !important;
		}

		.clip-thumbnail {
			position: relative;
			display: block;
			width: 4.5rem;
			height: 4.5rem;
			background-position: center;
			background-repeat: no-repeat;
			background-size: cover;
			border-radius: 50%;
			opacity: 0.85;
		}

		.clip-thumbnail .overlay {
			width: 100%;
			height: 100%;
			background-color: #fff3;
			border-radius: 50%;
			opacity: 0;
			transition: 0.7s ease;
			cursor: pointer;
		}

		.clip-thumbnail .overlay:hover {
			opacity: 0.9;
		}

		.clip-thumbnail .overlay,
		.clip-thumbnail .overlay i {
			display: block;
			position: absolute;
			left: 50% !important;
			top: 50% !important;
			transform: translate(-50%, -50%) !important;
			color: #27292aaa !important;
		}

		#levelsModal .modal-content {
			background-color: #1f2122;
			margin-top: 75%;
		}

		#levelsModal .modal-header {
			border-color: #1117 !important;
		}

		.profile-pic-cont {
			font-weight: bold !important;
			font-size: 1.15rem !important;
			font-size: 1rem !important;
			text-transform: lowercase !important;
		}

		.user-avatar {
			/* box-shadow: 10px 10px 10px 10px inset #1f212277 !important; */
			width: 21rem;
			height: 18rem;

			border-radius: 15px !important;
			clip-path: inset();
			object-fit: cover;
			object-position: center;
		}
	</style>
</head>

<body>

	<!-- ***** Preloader Start ***** -->
	<div id="js-preloader" class="js-preloader" style="display: none">
		<div class="preloader-inner">
			<span class="dot"></span>
			<div class="dots">
				<span></span>
				<span></span>
				<span></span>
			</div>
		</div>
	</div>
	<!-- ***** Preloader End ***** -->

	<!-- ***** Header Area Start ***** -->
	<header class="header-area header-sticky">
		<div class="container">
			<div class="row">
				<div class="col-12">
					<nav class="main-nav">
						<!-- ***** Logo Start ***** -->
						<a href="index.html" class="logo">
							<img src="assets/images/logo.png" alt="">
						</a>
						<!-- ***** Logo End ***** -->
						<!-- ***** Search End ***** -->
						<div class="search-input">
							<form id="search" action="#">
								<input type="text" placeholder="Type Something" id='searchText' name="searchKeyword"
									onkeypress="handle" />
								<i class="fa fa-search"></i>
							</form>
						</div>
						<!-- ***** Search End ***** -->
						<!-- ***** Menu Start ***** -->
						<ul class="nav">
							<li><a href="/">Home</a></li>
							<li><a href="/browse">Browse</a></li>
							<li><a href="/practice">Practice</a></li>
							<li><a href="/piano">Piano</a></li>
							<!-- <li><a href="/match">Match</a></li> -->
							<% if (!user) { %>
								<li class="login"><a href="/login" class="active">Login</a></li>
								<% } else { %>
									<li>
										<a href="/profile" class="active profile-pic-cont">Profile <span>
												<img class="profile-pic" src="<%= user.avatar %>" alt=""></span>
										</a>
									</li>
									<% } %>
										<!-- <li><a href="profile.html">Login <img src="assets/images/logo.png" alt=""></a></li> -->
						</ul>
						<a class='menu-trigger'>
							<span>Menu</span>
						</a>
						<!-- ***** Menu End ***** -->
					</nav>
				</div>
			</div>
		</div>
	</header>
	<!-- ***** Header Area End ***** -->

	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div class="page-content">

					<!-- ***** Banner Start ***** -->
					<div class="row">
						<div class="col-lg-12">
							<div class="main-profile ">
								<div class="row">
									<div class="col-lg-4">
										<% if (!user) { %>
											<img class="user-avatar" src="assets/images/logo.png" alt="">
											<% } else { %>
												<img class="user-avatar" src="<%= user.avatar %>" alt="">
												<% } %>
									</div>
									<div class="col-lg-4 align-self-center">
										<div class="main-info header-text">
											<span class="edit-profile" role="button" data-toggle="modal" data-target="#editModal">

												<i class="fas fa-user-edit"></i> Edit
											</span>
											<% if (!user) {%>
												<h4>Not Logged in</h4>
												<% } else { %>
													<h4
														style="text-transform: uppercase; font-weight: bold; font-size: 2rem; margin: 10px 0 20px 0;">
														<%= user.name %>
													</h4>
													<% } %>
														<% if (!user) {%>
															<p>You Haven't logged in yet. <br>Join us By pressing The Button Below.</p>
															<% } else { %>
																<p>You can customize your profile here. <br>Press the Button Below to Logout.</p>
																<% } %>
																	<div class="main-border-button">
																		<% if (!user) {%>
																			<a href="/login" class="text-primary login-btn">
																				<i class="fas fa-sign-in-alt"></i>
																				Login
																			</a>
																			<% } else { %>
																				<a href="/logout" class="text-primary logout-btn">
																					<i class="fas fa-sign-out-alt"></i>
																					Logout
																				</a>
																				<% } %>
																					<!-- <a href="#">Start Live Stream</a> -->
																	</div>
										</div>
									</div>

									<% // JavaScript code to convert milliseconds to a human-readable format const
										timeInMs=user.watchHour; const totalMinutes=Math.floor(timeInMs / (1000 * 60)); const
										hours=Math.floor(totalMinutes / 60); const minutes=totalMinutes % 60; const
										formattedTime=`${hours}hrs ${minutes}min`; %>


										<div class="col-lg-4 align-self-center">
											<ul>
												<li>Score <span>
														<%= user.score %>
													</span></li>
												<li>Stars Earned <span>
														<%= user.stars %>
													</span></li>
												<li>Musics Uploaded <span>
														<%= musics.filter(music=> music.userId = user._id).length %>
													</span></li>
												<li>Hours Practiced <span>
														<%= formattedTime %>
													</span></li>
											</ul>
										</div>
								</div>


								<div class="row">
									<div class="col-lg-12">
										<div class="clips">
											<div class="row">
												<div class="col-lg-12">
													<div class="heading-section">
														<h4><em>Your Most Popular</em> Musics</h4>
													</div>
												</div>

												<% musics.forEach(music=> { %>

													<div class="col-lg-3 col-sm-6">
														<div class="item music-clip"
															style="background-color: #27292a88; display: flex; flex-direction: row; flex-wrap: nowrap; align-items: center; padding: 0.4em; gap: 0.15em;">
															<div class="thumb" style="margin: 0;">
																<span data-id="<%= music._id %>" class="clip-thumbnail"
																	style="background-image: url('<%= music.thumbnail %>')">
																	<span class="overlay">

																		<i class="fas fa-play"></i>
																	</span>
																</span>
															</div>
															<div class="down-content"
																style="width: 100%; padding-left: 0.5em; display: flex; flex-direction: column; justify-content: space-around; gap: 0.25em">
																<h4 class="clip-title" data-id="<%= music._id %>"
																	style="line-height: 1.2; cursor: pointer;">
																	<%= music.title %>
																</h4>
																<div
																	style="display: flex; flex-direction: row; justify-content: flex-start; flex-wrap: wrap; gap: 1em">
																	<span><i class="fa fa-star"></i>
																		<%= music.rating.toFixed(2) %>
																	</span>
																	<span><i class="fa fa-users"></i>
																		<%= music.views %>
																	</span>
																</div>
															</div>
														</div>
													</div>

													<% }); %>

														<div class="col-lg-12">
															<div class="d-flex align-items-center my-3"
																style="margin: auto; width: 90%; display: none">
																<hr class="flex-grow-1" style="border-color: #57575722;">
																<span class="mx-3"><a class="btn btn-secondary"
																		style="background-color: #5e8de7; border: none; border-radius: 23px; font-weight: bold;"
																		href="/profile">Expand   <i class="fas fa-angle-double-down"></i> </a></span>
																<hr class="flex-grow-1" style="border-color: #57575722;">
															</div>
														</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<!-- ***** Banner End ***** -->

					<!-- ***** Gaming Library Start ***** -->
					<div class="gaming-library">
						<div class="col-lg-12">
							<div class="heading-section">
								<h4><em>Your Music</em> Library</h4>
								<div class="dropdown">
									<button class="btn btn-success dropdown-toggle" data-toggle="dropdown" aria-expanded="false"
										type="button">
										<i class="fas fa-filter"></i> <b>Filter</b>
									</button>
									<ul class="dropdown-menu bg-dark w-25 library-filter">
										<li class="dropdown-item bg-dark text-light favorites">

											<i class="fas fa-star text-warning"></i>  Favourites
										</li>
										<li class="dropdown-item bg-dark text-light uploaded">

											<i class="fas fa-cloud-upload-alt text-primary"></i>  Uploaded
										</li>
									</ul>
								</div>
							</div>

							<div class="music-library" style="display: block; margin-left: 3em; margin-right: 1em;">

							</div>

						</div>
						<div class="col-lg-12">
							<div class="d-flex align-items-center my-4" style="margin: auto; width: 90%; display: none">
								<hr class="flex-grow-1" style="border-color: #57575722;">
								<span class="mx-3"><a class="btn btn-secondary"
										style="background-color: #5e8de7; border: none; border-radius: 23px; font-weight: bold;"
										href="/profile">Expand   <i class="fas fa-angle-double-down"></i> </a></span>
								<hr class="flex-grow-1" style="border-color: #57575722;">
							</div>
						</div>
					</div>
					<!-- ***** Gaming Library End ***** -->
				</div>
			</div>
		</div>
	</div>

	<footer>
		<div class="container">
			<div class="row">
				<div class="col-lg-12">
					<p>Copyright © 2036 <a href="#">Cyborg Gaming</a> Company. All rights reserved.

						<br>Design: <a href="https://templatemo.com" target="_blank" title="free CSS templates">TemplateMo</a>
					</p>
				</div>
			</div>
		</div>
	</footer>



	<!-- Modals -->
	<div class="modal fade levels-modal" tabindex="-1" id="levelsModal" aria-labelledby="levelsModalLabel"
		aria-hidden="true">
		<%- include('levels.ejs') %>
	</div>
	<div class="modal fade edit-modal" tabindex="-1" id="editModal" aria-labelledby="levelsModalLabel" aria-hidden="true">
		<%- include('edit-profile.ejs') %>
	</div>



	<!-- Scripts -->
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
		integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous">
		</script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"
		integrity="sha384-+sLIOodYLS7CIrQpBjl+C7nPvqq+FbNUBDunl/OZv93DB7Ln/533i8e/mZXLi/P+" crossorigin="anonymous">
		</script>

	<script src="/js/popup.js" defer></script>
	<script src="/js/custom.js" defer></script>
	<script src="/js/levels.js" defer></script>
	<!-- <script src="/js/upload.js" defer></script> -->
	<script src="/js/toasts.js"></script>
	<script src="/js/affirm.js"></script>

	<script defer>
		$(document).ready(function () {
			$('.logout-btn').on('click', function (e) {
				e.preventDefault();
				affirm('Are u sure, you want to logout?').then((affirmed) => {
					if (affirmed) location.href = '/logout';
				});
			});
		}); // doc ready

	</script>


	<script defer>
		$(document).ready(function () {
			// $('#levelsModal').modal('show');

			/* eslint-disable no-undef */
			// const clips = JSON.parse('<%- JSON.stringify(musics).replace(/\\/g, `\\\\`).replace(/\'/g, `\\\\`) %>');
			const clips = JSON.parse('<%- JSON.stringify(musics).replace(/\\/g, `\\\\`).replace(/\'/g, `\\`) %>');
			/* eslint-enable no-undef */

			console.log('clips:', clips);

			// Function to find item by id
			function findClipById(id) {
				return clips.find(item => item._id === id);
			}

			// Event listener for item clicks
			$('.music-clip').each((index, element) => {
				console.log('element:', element);
				$(element).find('.clip-thumbnail, .clip-title').each((_, launcher) => {
					$(launcher).on('click', function (event) {

						console.log('launching modal...');
						const clipId = $(launcher).data('id');
						const clip = findClipById(clipId);
						if (clip) {
							console.log('launched');
							$('#levelsModal .level-selector-title').text(`${clip.artist} - ${clip.title}`);
							$('#levelsModal .thumbnail-img').attr('src', clip.thumbnail);
							$('#levelsModal input[name="music"]').val(clip._id);

							$('.levels-form').find('.thumbnail-img-overlay i').removeClass('far fas');
							if (clip.favorite)
								$('.levels-form').find('.thumbnail-img-overlay i').addClass('fas');
							else $('.levels-form').find('.thumbnail-img-overlay i').addClass('far');
							$('#levelsModal').modal('show');
						}
					})
				});
			});



			$('.edit-avatar').click(function (e) {
				e.preventDefault();
				$('#thumbnail-upload').trigger('click');
			});

			$('#thumbnail-upload').on('cancel', () => {
				console.log('Cancelled.');
			});

			$('#thumbnail-upload').on('change', function () {
				let element = $(this).prev()[0];
				let file = this.files[0];
				let type = element.dataset.type;

				var formData = new FormData();
				formData.append('file', file);
				formData.append('type', type);

				const xhr = new XMLHttpRequest();
				xhr.open('POST', '/upload', true);

				xhr.onreadystatechange = () => {
					if (xhr.readyState === 4 && xhr.status === 200) {
						console.log('Upload complete!');
						let response = JSON.parse(xhr.response);
						$('.edit-avatar').css('background-image', `url('/${response.path}')`);
						$('.edit-avatar').find('input[name="avatar"]').val(`${response.path}`);
						toastSuccess('Thumbnail uploaded successfully!');
					} else if (xhr.readyState == 4) {
						let response = { error: 'nothing' };
						if (xhr.responseText) {
							try {
								response = JSON.parse(xhr.responseText);
								console.log('response:', response);
							} catch (e) {
								console.error('Parsing error:', e);
							}
						} else {
							console.warn('Empty response');
						}
					}
				};

				xhr.send(formData);
			});


			$('#edit-form').on('submit', function (e) {
				e.preventDefault();
				const formData = new FormData(this);

				$('.spinner-overlay').show();
				fetch('/profile/edit', {
					method: 'PUT',
					headers: {
						'Accept': 'application/json'
					},
					body: formData
				}).then(res => {
					if (!res.ok) return res.json().then(err => Promise.reject(err));
					return res.json();
				}).then(res => {
					$('.spinner-overlay').hide();
					console.log('res:', res);
					toastSuccess(res.message);
					$('#editModal').modal('hide');
					setTimeout(() => {
						location.reload();
					}, 100);
				}).catch(err => {
					console.error(err);
				});
			});
		});
	</script>

</body>

</body>

</html>